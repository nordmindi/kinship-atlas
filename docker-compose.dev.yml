# Docker Compose for Local Development
# This file provides an alternative way to run Supabase locally
# Use this if you prefer Docker Compose over the Supabase CLI
#
# Data Persistence:
# Database and storage data are stored in ./docker-data/ using bind mounts.
# This ensures data persists through Docker restarts and computer restarts.
# The docker-data/ directory is automatically created and excluded from git.

services:
  # PostgreSQL Database
  db:
    image: supabase/postgres:15.1.1.78
    container_name: kinship-atlas-db
    ports:
      - "60000:5432"
    environment:
      POSTGRES_HOST: /var/run/postgresql
      PGPORT: 5432
      POSTGRES_PORT: 5432
      PGPASSWORD: postgres
      POSTGRES_PASSWORD: postgres
      PGDATABASE: postgres
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      PGDATA: /var/lib/postgresql/data
    volumes:
      - ./docker-data/db:/var/lib/postgresql/data
      - ./supabase/init-auth-schema.sql:/docker-entrypoint-initdb.d/00-init-auth-schema.sql:ro
      - ./supabase/init-auth-types.sql:/docker-entrypoint-initdb.d/01-init-auth-types.sql:ro
      - ./supabase/migrations:/docker-entrypoint-initdb.d/migrations:ro
      - ./supabase/seed.sql:/docker-entrypoint-initdb.d/seed.sql:ro
    healthcheck:
      # Important: check TCP readiness, not just unix socket readiness.
      # GoTrue (auth) connects over the Docker network via db:5432.
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Supabase API
  api:
    image: supabase/gotrue:v2.158.1
    container_name: kinship-atlas-api
    ports:
      - "60001:9999"
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: http://localhost:60011
      GOTRUE_API_EXTERNAL_URL: http://localhost:60011
      GOTRUE_DB_DRIVER: postgres
      # Ensure unqualified queries (e.g. "FROM users") can resolve to auth.users,
      # while keeping migration tracking on public.schema_migrations (which is already up to date).
      # search_path order matters: public first (for schema_migrations), auth next (for users).
      GOTRUE_DB_DATABASE_URL: postgres://postgres:postgres@db:5432/postgres?options=-csearch_path%3Dpublic,auth,extensions
      # GoTrue schema/namespace for auth tables (auth.users, auth.refresh_tokens, etc).
      # GoTrue reads this via env var DB_NAMESPACE (default: auth).
      DB_NAMESPACE: auth
      GOTRUE_SITE_URL: http://localhost:8080
      GOTRUE_URI_ALLOW_LIST: http://localhost:3000,https://localhost:3000,http://localhost:5173,http://localhost:8080,https://localhost:8080,http://localhost:60002
      GOTRUE_DISABLE_SIGNUP: false
      GOTRUE_JWT_ADMIN_ROLES: service_role
      GOTRUE_JWT_AUD: authenticated
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      GOTRUE_EXTERNAL_EMAIL_ENABLED: true
      GOTRUE_MAILER_AUTOCONFIRM: true
      GOTRUE_SMTP_ADMIN_EMAIL: admin@example.com
      GOTRUE_SMTP_HOST: inbucket
      GOTRUE_SMTP_PORT: 2500
      GOTRUE_SMTP_USER: fake_mail_user
      GOTRUE_SMTP_PASS: fake_mail_password
      GOTRUE_SMTP_SENDER_NAME: fake_sender
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9999/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Supabase Studio
  studio:
    image: supabase/studio:latest
    container_name: kinship-atlas-studio
    ports:
      - "60002:3000"
    environment:
      STUDIO_PG_META_URL: http://meta:8080
      POSTGRES_PASSWORD: postgres
      DEFAULT_ORGANIZATION_NAME: Default Organization
      DEFAULT_PROJECT_NAME: Default Project
      SUPABASE_URL: http://proxy:8000
      SUPABASE_PUBLIC_URL: http://localhost:60011
      SUPABASE_INTERNAL_URL: http://proxy:8000
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      SUPABASE_SERVICE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
    depends_on:
      api:
        condition: service_healthy

  # Email Testing (Inbucket)
  inbucket:
    image: inbucket/inbucket:3.0.3
    container_name: kinship-atlas-inbucket
    ports:
      - "60003:9000"
      - "60004:2500"
      - "60005:1100"
    environment:
      INBUCKET_WEB_ADDR: 0.0.0.0:9000
      INBUCKET_POP3_ADDR: 0.0.0.0:1100
      INBUCKET_SMTP_ADDR: 0.0.0.0:2500

  # Storage
  storage:
    image: supabase/storage-api:v1.10.3
    container_name: kinship-atlas-storage
    ports:
      - "60006:5000"
    environment:
      ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      SERVICE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
      POSTGREST_URL: http://rest:3000
      PGRST_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      DATABASE_URL: postgres://postgres:postgres@db:5432/postgres
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      REGION: stub
      GLOBAL_S3_BUCKET: stub
      ENABLE_IMAGE_TRANSFORMATION: true
      IMGPROXY_URL: http://imgproxy:8080
    volumes:
      - ./docker-data/storage:/var/lib/storage
    depends_on:
      db:
        condition: service_healthy

  # Image Proxy
  imgproxy:
    image: darthsim/imgproxy:v3.8.0
    container_name: kinship-atlas-imgproxy
    ports:
      - "60007:8080"
    environment:
      IMGPROXY_BIND: ":8080"
      IMGPROXY_LOCAL_FILESYSTEM_ROOT: /
      IMGPROXY_USE_ETAG: true
      IMGPROXY_ENABLE_WEBP_DETECTION: true
    volumes:
      - ./docker-data/storage:/var/lib/storage:ro

  # Realtime
  realtime:
    image: supabase/realtime:v2.30.15
    container_name: kinship-atlas-realtime
    ports:
      - "60008:4000"
    environment:
      PORT: 4000
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: postgres
      DB_AFTER_CONNECT_QUERY: 'SET search_path TO _realtime'
      DB_ENC_KEY: supabaserealtime
      API_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      FLY_ALLOC_ID: fly123
      FLY_APP_NAME: realtime
      SECRET_KEY_BASE: UpNVntn3cDxHJpq99YMc1T1AQgQpc8kfYTuRgBiYa15BLrx8etQoXz3gZv1/u2oq
      ERL_AFLAGS: -proto_dist inet_tcp
      ENABLE_TAILSCALE: false
      DNS_NODES: "''"
    depends_on:
      db:
        condition: service_healthy

  # PostgREST
  rest:
    image: postgrest/postgrest:v12.2.0
    container_name: kinship-atlas-rest
    ports:
      - "60009:3000"
    environment:
      PGRST_DB_URI: postgres://postgres:postgres@db:5432/postgres
      PGRST_DB_SCHEMAS: public,storage,graphql_public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      PGRST_DB_USE_LEGACY_GUCS: false
      PGRST_APP_SETTINGS_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      PGRST_APP_SETTINGS_JWT_EXP: 3600
    depends_on:
      db:
        condition: service_healthy

  # Meta
  meta:
    image: supabase/postgres-meta:v0.84.2
    container_name: kinship-atlas-meta
    ports:
      - "60010:8080"
    environment:
      PG_META_PORT: 8080
      PG_META_DB_HOST: db
      PG_META_DB_PORT: 5432
      PG_META_DB_NAME: postgres
      PG_META_DB_USER: postgres
      PG_META_DB_PASSWORD: postgres
    depends_on:
      db:
        condition: service_healthy

  # Nginx reverse proxy (routes Supabase endpoints: /auth/v1/*, /rest/v1/*, /storage/v1/*)
  proxy:
    image: nginx:alpine
    container_name: kinship-atlas-proxy
    ports:
      - "60011:8000"
    volumes:
      - ./kong/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      api:
        condition: service_healthy
      rest:
        condition: service_started
      storage:
        condition: service_started
    restart: unless-stopped

networks:
  default:
    name: kinship-atlas-network
