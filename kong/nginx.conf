events {
    worker_connections 1024;
}

http {
    upstream gotrue {
        server api:9999;
    }

    upstream postgrest {
        server rest:3000;
    }

    upstream storage {
        server storage:5000;
    }

    server {
        listen 8000;
        
        # Auth endpoint (GoTrue)
        location /auth/v1/ {
            # Hide upstream CORS headers to avoid duplicates
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            proxy_hide_header 'Access-Control-Expose-Headers';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            proxy_hide_header 'Vary';

            # Handle preflight requests
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'authorization,apikey,content-type,x-client-info,x-supabase-api-version,accept-profile,content-profile,x-upsert' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Length' 0 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                return 204;
            }

            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'authorization,apikey,content-type,x-client-info,x-supabase-api-version,accept-profile,content-profile,x-upsert' always;
            add_header 'Access-Control-Expose-Headers' 'content-range,content-length,x-supabase-api-version' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Vary' 'Origin' always;

            proxy_pass http://gotrue/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # PostgREST endpoint (database queries via supabase.from())
        location /rest/v1/ {
            # Hide upstream CORS headers to avoid duplicates
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            proxy_hide_header 'Access-Control-Expose-Headers';
            proxy_hide_header 'Vary';

            # Handle preflight requests
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'authorization,apikey,content-type,x-client-info,x-supabase-api-version,prefer,accept-profile,content-profile' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Length' 0 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                return 204;
            }

            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'authorization,apikey,content-type,x-client-info,x-supabase-api-version,prefer,accept-profile,content-profile' always;
            add_header 'Access-Control-Expose-Headers' 'content-range,content-length,x-supabase-api-version' always;
            add_header 'Vary' 'Origin' always;

            proxy_pass http://postgrest/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Storage endpoint (file uploads via supabase.storage)
        location /storage/v1/ {
            # Allow large file uploads (50MB to match storage service FILE_SIZE_LIMIT)
            client_max_body_size 50M;
            client_body_buffer_size 128k;
            
            # Hide upstream CORS headers to avoid duplicates
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            proxy_hide_header 'Access-Control-Expose-Headers';
            proxy_hide_header 'Vary';

            # Handle preflight requests
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'authorization,apikey,content-type,x-client-info,x-supabase-api-version,accept-profile,content-profile,x-upsert' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Length' 0 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                return 204;
            }

            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'authorization,apikey,content-type,x-client-info,x-supabase-api-version,accept-profile,content-profile,x-upsert' always;
            add_header 'Access-Control-Expose-Headers' 'content-range,content-length,x-supabase-api-version' always;
            add_header 'Vary' 'Origin' always;

            # Increase timeouts for large file uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            send_timeout 300s;

            proxy_pass http://storage/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

