name: Release to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*'

env:
  NODE_VERSION: '20.x'

jobs:
  # Pre-release checks
  pre-release-checks:
    name: Pre-Release Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all CI checks
        run: npm run ci:check

      - name: Verify package.json version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $VERSION"
          if [[ "$VERSION" == "0.0.0" ]]; then
            echo "⚠️  Warning: Version is still 0.0.0"
          fi

  # Create Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: pre-release-checks
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release notes
        id: release_notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "# Release $TAG" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Changes" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false

  # Deploy to Production (if configured)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-release-checks]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://your-production-url.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          VITE_SUPABASE_MODE: remote
          VITE_SUPABASE_URL_REMOTE: ${{ secrets.VITE_SUPABASE_URL_REMOTE }}
          VITE_SUPABASE_ANON_KEY_REMOTE: ${{ secrets.VITE_SUPABASE_ANON_KEY_REMOTE }}

      - name: Deploy to Vercel (if configured)
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            npm run vercel:deploy
          else
            echo "Vercel deployment skipped - token not configured"
          fi
        continue-on-error: true

      - name: Post-deployment health check
        run: |
          echo "Deployment completed. Run health checks on production."
          # Add production health check here if needed

