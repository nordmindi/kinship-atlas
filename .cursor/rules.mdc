# =========================================================
# Cursor Development Rules & AI Collaboration Guide ‚Äî Kinship Atlas
# Generic, reusable baseline for genealogy apps
# =========================================================

## üìú Core Philosophy
principles:
  - "Simplicity & Clarity: Prefer small, composable changes over large rewrites; optimize for readability and maintainability."
  - "Separation of Concerns: Strictly separate End-User App area from Platform/Admin area in code, routing, and UI."
  - "Privacy & Safety by Default: Treat living-person data as sensitive; explicit consent and strict access rules."
  - "Test What Matters: Business rules, privacy/role access, and core flows must be tested."
  - "Iterate with Evidence: Make incremental changes, measure impact, document outcomes in PR status notes."

## üß≠ Project Context (Generic)
product:
  name: "Kinship Atlas"
  description: "Genealogy platform where users create members, add connections, attach images & documents, write stories, and collaborate."
user-groups:
  end_user_side:
    - viewer
    - collaborator
    - family_admin
    - genealogist
  platform_side:
    - platform_admin
    - owner
key-domains:
  - Members & Profiles (living/deceased, dates, places)
  - Relationships (parent/child, spouse/partner, siblings, custom)
  - Media (images, docs, audio), Stories & Timelines
  - Privacy & Sharing (private/family/public)
  - Collaboration & Roles per tree
  - Audit logs & Activity feed
  - Import/Export (GEDCOM), Duplicates merge
  - Search & Hints
tech-stack: # adapt as needed
  frontend: "React 18 + TypeScript, Vite, Tailwind, React Router v6, TanStack Query v5, RHF + Zod, shadcn/ui + Radix, Recharts"
  backend: "Supabase (Auth, DB, Storage) or compatible"
  testing: "Vitest + Testing Library, Playwright/Cypress for E2E"

must-read:
  - "APPLICATION_DEVELOPMENT_INSTRUCTIONS.md"

## üèóÔ∏è Architecture Guardrails
areas:
  - name: "End-User App"
    layout: "AppLayout = Sidebar + Header + <main/>"
    routes: ["/app/*"]
    allowedRoles: ["viewer","collaborator","family_admin","genealogist"]
  - name: "Admin/Platform"
    layout: "AdminLayout wraps pages in DashboardShell (shell owns header + nav)"
    routes: ["/admin/*"]
    allowedRoles: ["platform_admin","editor", "viewer"]

rules:
  - "Never Mix Layouts: Pages must not import Sidebar, Header, or DashboardShell directly; layouts own navigation."
  - "Shared Components: Only truly shared UI goes in components/common. Admin UI in components/admin, app-specific in components/app."
  - "Service Layer: Use domain services under src/services with clear interfaces & typed DTOs. Prefer hook wrappers (useMembers, useStories, useTree, etc.)"
  - "Feature Flags / Env: Use VITE_... flags; mock data allowed in dev only."

## üîê Authentication, Privacy & RBAC (Must-Follow)
roles:
  END_USER_ROLES: ["viewer","collaborator","family_admin","genealogist"]
  MANAGEMENT_ROLES: ["platform_admin","owner"]

auth-lib:
  path: "src/lib/auth/roles.ts"
  snippet: |
    export const END_USER_ROLES = ["viewer","collaborator","family_admin","genealogist"] as const;
    export const MANAGEMENT_ROLES = ["platform_admin","owner"] as const;
    export type Role = typeof END_USER_ROLES[number] | typeof MANAGEMENT_ROLES[number];
    export const isEndUserRole = (r?: string) => !!r && (END_USER_ROLES as readonly string[]).includes(r!);
    export const isManagementRole = (r?: string) => !!r && (MANAGEMENT_ROLES as readonly string[]).includes(r!);

route-protection:
  snippet: |
    <Routes>
      <Route path="/app/*" element={
        <ProtectedRoute allowedRoles={END_USER_ROLES}>
          <AppLayout><AppRoutes/></AppLayout>
        </ProtectedRoute>
      }/>
      <Route path="/admin/*" element={
        <ProtectedRoute allowedRoles={MANAGEMENT_ROLES}>
          <AdminLayout><AdminRoutes/></AdminLayout>
        </ProtectedRoute>
      }/>
    </Routes>

protected-route-contract:
  - "Unauthenticated ‚Üí /login"
  - "Unauthorized ‚Üí /unauthorized"
  - "No flashing wrong layout during loading"
  - "End-User must never see DashboardShell; Admin must never see App Sidebar+Header"

privacy:
  policies:
    - "Default to private for living persons; require explicit consent to broaden visibility."
    - "Privacy levels: private (owner & invited), family (tree collaborators), public (anonymized if living)."
    - "Per-entity privacy: member, media, story each carry a privacy scope; effective visibility = most restrictive."
    - "Redact sensitive fields for living persons when viewer lacks permission (e.g., exact dates, precise locations)."
    - "All access paths must enforce server-side checks; client checks are additive."

## üß© Layout Contracts
layouts:
  AppLayout:
    renders: ["Sidebar","Header","<main/>"]
    testids: ["app-header","app-sidebar"]
  AdminLayout:
    renders: ["<DashboardShell>{children}</DashboardShell>"]
    testids: ["shell-root"]

## üì¶ File & Folder Structure (Enforced)
structure: |
  src/
    components/
      common/         # Truly shared
      app/            # End-user app features (tree, members, media, stories)
      admin/          # Admin platform features (plans, moderation, platform settings)
      layouts/
        AppLayout/
        AdminLayout/
      ui/             # shadcn/ui wrappers
    pages/            # Route components (thin; no layout imports)
    hooks/            # useMembers, useStories, useRelationships, useMedia, useTree
    services/         # MemberService, RelationshipService, MediaService, StoryService, TreeService, ImportExportService, AuditLogger
    types/            # DTOs, domain types
    utils/            # Helpers (date/place normalizers, GEDCOM utils)
    config/           # env, feature flags
    i18n/             # translations (if used)
    styles/           # global styles
rule: "Pages are presentation-only; business logic stays in hooks/services."

## üß™ Testing Rules & Quality Assurance
strategy:
  unit: "Components, hooks, services with Vitest + Testing Library"
  integration: "Layouts + route guards + data hooks"
  e2e: "Critical user flows + cross-area contamination + privacy redaction"
coverage:
  minNewFeatures: 80
  minCriticalPaths: 90

mandatory-testing:
  - "ALL new functionality MUST include tests - no exceptions"
  - "New components require component tests with React Testing Library"
  - "New services/hooks require unit tests with Vitest"
  - "New utilities require unit tests"
  - "New features require integration tests for critical paths"
  - "Tests must be written in the same PR/commit as the feature"
  - "Test files must be co-located: `__tests__/` directory next to source files"
  - "Test naming: `*.test.ts` for utilities/services, `*.test.tsx` for components"

test-requirements:
  - "Test happy paths and error scenarios"
  - "Test edge cases and boundary conditions"
  - "Test authentication and authorization"
  - "Test data validation and error handling"
  - "Test loading states and async operations"
  - "Mock external dependencies (Supabase, APIs, file operations)"
  - "Use realistic test data that matches production structure"

e2e-assertions:
  - 'End-user route never contains data-testid="shell-root"'
  - 'Admin route never contains data-testid="app-header"'
  - "Living profiles redact sensitive fields for unauthorized viewers"
  - "Media & story privacy respected across share links"

mocking:
  - "MSW for APIs"
  - "Mock Supabase client & storage"
  - "vi.mock() for modules"
  - "Deterministic fake media uploads"

## üõ°Ô∏è Security & Compliance
security:
  input-validation: "Zod schemas on all inputs; DOMPurify for any rendered HTML."
  least-privilege: "Server/edge checks authoritative; client checks additive."
  sensitive-storage: "No sensitive data in localStorage; prefer memory or secure cookies via auth session."
  audit-logging: "AuditLogger for member edits, merges, privacy changes, collaborator invites, exports."
  error-boundaries: "No sensitive stack traces in UI; secure logging channel."
  living-person-protection:
    - "Redact PII (dates/locations) without proper role or consent"
    - "Require confirmation before broadening visibility on living profiles"
    - "Anonymize or aggregate when exporting public data"

## ‚öôÔ∏è Code Style & Quality Standards
typescript:
  strict: true
  rules:
    - "No any unless documented and unavoidable"
    - "Interfaces/Types for all DTOs"
    - "Generics for reusable components/hooks"
    - "Unions for state machines"

linting:
  mandatory:
    - "ALL code MUST pass ESLint before commit - no exceptions"
    - "Fix ALL linting errors before submitting PR"
    - "Run `npm run lint` before committing"
    - "Use `npm run lint:fix` to auto-fix issues when possible"
    - "TypeScript errors are linting failures - fix all type errors"
    - "No console.log in production code (use proper logging)"
    - "No unused imports or variables"
    - "Follow consistent code formatting (Prettier)"
  pre-commit:
    - "Run linting as part of pre-commit hook"
    - "CI pipeline will fail on linting errors"
    - "Review linting output before pushing"
react:
  patterns:
    - "Functional components with hooks"
    - "Pure components; side effects only in hooks"
    - "useMemo for expensive calculations"
    - "Stable callbacks with useCallback"
    - "Correct dependency arrays"
styling:
  tailwind:
    - "Use semantic tokens (bg-background, text-primary); no raw color literals"
    - "Mobile-first responsive design"
    - "Consistent spacing via Tailwind scale"
a11y:
  standard: "WCAG 2.1 AA"
  checklist:
    - "Semantic HTML"
    - "ARIA where needed"
    - "Keyboard navigation"
    - "Screen reader labels"
    - "Color contrast upheld"

quality-gates:
  commands:
    - "npm run lint" # MUST pass - no exceptions
    - "npm run lint:fix" # Auto-fix linting issues
    - "npm run type-check" # MUST pass - no type errors
    - "npm run test" # MUST pass - all tests green
    - "npm run test:coverage" # Check coverage thresholds
    - "npm run build" # MUST succeed
  enforcement:
    - "All quality gates MUST pass before merge"
    - "No bypassing linting or type checking"
    - "Test failures block merge"
    - "Coverage below threshold blocks merge"

## üîÅ Workflow & Prompts (for Cursor & AI)
before-coding:
  - "Read APPLICATION_DEVELOPMENT_INSTRUCTIONS.md"
  - "Identify area: End-User or Admin; confirm allowed roles"
  - "Locate target files; outline smallest possible change"
  - "Check if data structures are changing - import/export may need updates"
while-coding:
  - "Keep diffs small and isolated"
  - "No cross-area imports"
  - "Add/update tests in the same PR - MANDATORY"
  - "Fix linting errors immediately"
  - "If adding new data fields/types, check import/export functions"
after-coding:
  - "Run `npm run lint` and fix all errors"
  - "Run `npm run type-check` and fix all type errors"
  - "Write tests for new functionality"
  - "Run `npm run test` and ensure all pass"
  - "Update import/export if data structures changed"
commits:
  examples:
    - "feat(app): add parent-child linking with duplicate detection"
    - "fix(admin): enforce platform role guard on /admin/moderation"
    - "refactor(common): extract media uploader with EXIF stripping"
ai-prompt-examples:
  - "Implement useMembers with Query v5, typed filters (name/date/place), and privacy-aware selection."
  - "Update ProtectedRoute to prevent cross-layout flashes; add tests for both areas."
  - "Add Zod validation for member form (dates/places), show RHF errors, and write unit tests."
  - "Implement GEDCOM import with dry-run report and conflict detection; add integration tests."

## üì•üì§ Import/Export Data Management (CRITICAL)
import-export-rules:
  mandatory-updates:
    - "When adding new data types (albums, categories, etc.), MUST update both import and export"
    - "When modifying data structures, MUST update import/export to maintain compatibility"
    - "When adding new relationships, MUST include them in export and handle in import"
    - "Export MUST include all IDs and relationships for data coherence"
    - "Import MUST handle missing optional fields gracefully"
  
  export-requirements:
    - "Export ALL data types: familyMembers, relationships, stories, locations, media, artifacts, albums, storyCategories"
    - "Export ALL relationships: album-media, album-familyGroups, album-familyMembers, album-storyCategories, story-members"
    - "Preserve ALL IDs for proper import matching"
    - "Include metadata: timestamps, user IDs, categories, etc."
    - "Support both JSON and Excel formats"
    - "Export must be complete and coherent for cross-environment migration"
  
  import-requirements:
    - "Handle missing fields gracefully (backward compatibility)"
    - "Map old IDs to new IDs when importing"
    - "Handle duplicate detection (members, relationships)"
    - "Preserve relationships during import"
    - "Support incremental imports (skip existing data)"
    - "Validate data structure before import"
    - "Provide detailed import reports (success, warnings, errors)"
  
  files-to-update:
    - "src/components/family/ExportFamilyData.tsx - Update when adding new data types"
    - "src/components/family/ImportFamilyData.tsx - Update when adding new data types"
    - "Export interface must match import interface"
    - "Both JSON and Excel formats must be updated"
  
  checklist:
    - "[ ] Export includes new data type"
    - "[ ] Import handles new data type"
    - "[ ] All relationships exported"
    - "[ ] All relationships imported"
    - "[ ] IDs preserved in export"
    - "[ ] ID mapping works in import"
    - "[ ] Tests updated for new data types"
    - "[ ] Backward compatibility maintained"

## üìà Performance & DX
performance:
  tanstack-query: "Set sensible staleTime; avoid over-fetching; stable cache keys"
  code-splitting: "Lazy-load heavy pages (timeline, media gallery, analytics)"
  charts: "Memoize datasets; isolate Recharts"
  devtools: "Enable React Query DevTools in dev; feature-flag heavy mocks"
  bundle: "Tree-shake shadcn/ui & lucide-react"
  media:
    - "Generate responsive image sizes/thumbnails"
    - "Strip EXIF on upload (privacy)"
    - "Defer heavy processing (face detection, OCR) behind flags"

## üö® Common Pitfalls (and What To Do)
pitfalls:
  - "Duplicate nav/header: move layout elements back to layouts; assert via E2E"
  - "Unauthorized data leakage: re-check role & privacy mapping; add guard tests"
  - "Infinite re-renders: verify hook deps; memoize selectors/callbacks"
  - "Stale trees after mutations: invalidate precise query keys"
  - "Mismatched privacy on media/story: enforce effective visibility rule in selectors & queries"
  - "Date/place parsing issues: centralize parsing in utils and test edge cases"

## ‚úÖ Definition of Done (Checklist)
development:
  - "[ ] Feature implemented with strict TypeScript"
  - "[ ] No unapproved any"
  - "[ ] Proper error handling & loading states"
  - "[ ] A11y (WCAG 2.1 AA) & responsive"
testing:
  - "[ ] Unit tests for components/hooks/services - MANDATORY for new features"
  - "[ ] Integration tests for complex flows"
  - "[ ] Coverage ‚â• 80% (new), ‚â• 90% (critical)"
  - "[ ] Error paths & privacy redaction tested"
  - "[ ] Tests written in same PR as feature"
  - "[ ] All tests passing before merge"
quality:
  - "[ ] ESLint passes - MANDATORY (run `npm run lint`)"
  - "[ ] All linting errors fixed - MANDATORY"
  - "[ ] Type-check passes - MANDATORY (run `npm run type-check`)"
  - "[ ] Prettier applied"
  - "[ ] Imports sorted"
  - "[ ] No console.log in prod"
  - "[ ] No unused imports or variables"
import-export:
  - "[ ] Export updated if new data types added"
  - "[ ] Import updated if new data types added"
  - "[ ] All relationships included in export"
  - "[ ] All relationships handled in import"
  - "[ ] IDs preserved for data coherence"
  - "[ ] Backward compatibility maintained"
  - "[ ] Tests updated for import/export changes"
architecture-security:
  - "[ ] Layout rules respected (no cross-area UI)"
  - "[ ] RBAC & privacy enforced server-side"
  - "[ ] Zod input validation"
  - "[ ] Audit logs for sensitive actions"
  - "[ ] Performance reviewed; no obvious leaks/re-renders"
build-deploy:
  - "[ ] Build passes"
  - "[ ] Bundle size reasonable (npm run analyze)"
  - "[ ] Env vars configured"
  - "[ ] Feature flags toggled as needed"
docs:
  - "[ ] README and API docs updated"
  - "[ ] Changelog updated"
  - "[ ] Migration notes if breaking"
final-verification:
  - "[ ] Manual QA in browser"
  - "[ ] Cross-browser check"
  - "[ ] Mobile responsiveness"
  - "[ ] Screen reader spot-check"
  - "[ ] Error boundaries verified"
  - "[ ] Privacy views verified for viewer vs collaborator vs family_admin"

## üìÇ Quick References
references:
  app-doc: "APPLICATION_DEVELOPMENT_INSTRUCTIONS.md"
  layouts: "components/layouts/{AppLayout,AdminLayout}"
  rbac: "lib/auth/roles.ts, components/common/ProtectedRoute.tsx"
  services: "src/services/* (MemberService, RelationshipService, MediaService, StoryService, TreeService, ImportExportService, AuditLogger)"
  testing: "Vitest, Testing Library, MSW, Playwright/Cypress"
